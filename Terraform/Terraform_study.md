# Terraform Study

**Terraform : 인프라스트럭처 도구 (프로비저닝 도구)**
- 코드소서의 인프라스트럭처를 지향하고 있는 도구
- GUI나 웹 콘솔을 통해 서비스 실행에 필요한 리소스를 관리하는 대신 필요한 일소스들을 선언적인 코드로 작성해 관리할 수 있도록 해줍니다.

### 테라폼 설치
- `Mac`에서는 `Homebrew`를 사용해 간단히 설치 가능합니다.
  ```
    $ brew install terraform
  ```

- 버전 확인
  ```
    $ terraform version
  ```

### 테라폼 버전 관리
- 특정 버전의 테라폼을 사용하고 싶거나, 여러 버전을 사용할 필요가 있을 때는 `tfenv`를 사용하면 편리합니다.
- `tfenv`는 테라폼 버전 매니저로 `Mac`, `Linux`, `Windows`를 지원하고 있습니다.
  <br>
  ```
    $ brew install tfenv
    $ tfenv install 0.12.23
    $ tfenv use 0.12.23
    $ terraform version
  ```

### 테라폼을 사용한 웹 애플리케이션 인프라스트럭처 프로비저닝
- 1단계 - 먼저 아마존 웹 서비스 계정을 준비하고, `API 키`를 설정합니다.
- 2단계 스텝 1 - 인프라스트럭처를 정의하는 `HCL 언어`로 필요한 리소스를 선언합니다.
- 2단계 스텝 2 - 선언된 리소스들이 생성가능한지 계획(`Plan`)을 확인합니다.
- 2단계 스텝 3 - 선언된 리소스들을 아마존 웹 서비스에 적용(`Apply`)합니다.
- 3단계 - 웹 애플리케이션을 `배포`합니다.

### 테라폼의 기본 개념들
#### `프로비저닝 (Provisioning)`
- 어떤 프로세스나 서비스를 실행하기 위한 준비 단계를 프로비저닝이라고 이야기합니다. 
- 프로비저닝에는 크게 네트워크나 컴퓨팅 자원을 준비하는 작업과 준비된 컴퓨팅 자원에 사이트 패키지나 애플리케이션 의존성을 준비하는 단계로 나뉘어집니다. 
- 명확한 경계는 불분명하지만 테라폼은 전자를 주로 다루는 도구입니다.

#### `프로바이더 (Provider)`
- 테라폼과 `외부 서비스를 연결해주는 기능`을 하는 모듈입니다. 
- 예를 들어 테라폼으로 AWS 서비스의 컴퓨팅 자원을 생성하기 위해서는 aws 프로바이더를 먼저 셋업해야합니다.

#### `리소스 (Resource)`
- 리소스란 특정 프로바이더가 제공해주는 `조작 가능한 대상의 최소 단위`입니다. 
- 예를 들어 AWS 프로바이더는 aws_instance 리소스 타입을 제공하고, 이 리소스 타입을 사용해 Amazon EC2의 가상 머신 리소스를 선언하고 조작하는 것이 가능합니다. 
- EC2 인스턴스, 시큐리티 그룹, 키 페어 모두 aws 프로바이더가 제공해주는 리소스 타입입니다.

#### `HCL (Hashicorp Configuration Language)`
- HCL은 `테라폼에서 사용하는 설정 언어`입니다. 테라폼에서 모든 설정과 리소스 선언은 HCL을 사용해 이루어집니다. 테라폼에서 HCL 파일의 확장자는 `.tf`를 사용합니다.

#### `계획 (Plan)`
- 테라폼 프로젝트 디렉터리 아래의 모든 `.tf 파일의 내용을 실제로 적용 가능한지 확인하는 작업`을 계획이라고 합니다. 테라폼은 이를 `terraform plan` 명령어로 제공하며, 이 명령어를 실행하면 어떤 리소스가 생성되고, 수정되고, 삭제될지 계획을 보여줍니다.

#### `적용 (Apply)`
- 테라폼 프로젝트 디렉터리 아래의 모든 `.tf 파일의 내용대로 리소스를 생성, 수정, 삭제하는 일`을 적용이라고 합니다. 테라폼은 이를 `terraform apply` 명령어로 제공합니다. 이 명령어를 실행하기 전에 변경 예정 사항은 plan 명령어를 사용해 확인할 수 있습니다. 적용하기 전에도 플랜의 결과를 보여줍니다.

### 첫 번째 단계 - AWS 설정
- **이미 AWS 계정을 가지고 있으며, IAM 계정에 대해 이해하고 있다면 두 번째 단계로 넘어가주세요.**
<br>
1. AWS에 로그인 합니다. 
2. AWS IAM을 발급합니다.
3. 해당 권한은 기존 정책에 직접 연결하여 `AdministratorAccess`를 체크해주어 발급합니다.

### 두 번째 단계 - HCL로 리소스 정의하고 AWS에 프로비저닝

#### AWS 프로바이더 정의
```
$ mkdir web_infra
$ cd web_infra
$ touch provider.tf web_infra.tf
```


> 디렉터리 이름과 파일 이름에 특별한 원칙은 없습니다.
> 테라폼은 기본적으로 특정 디렉터리에 있는 모든 .tf 확장자를 가진 파일을 전부 읽어들인 후, 리소스 생성, 수정, 삭제 작업을 진행합니다. 
> 파일은 상황에 따라 적절히 나눠줄 필요가 있지만, 여기서는 작성할 내용이 많지 않기 때문에  provider.tf와 web_infra.tf 두 개로 나눠서 작성해보겠습니다.


- HCL AWS 프로바이더 정의 (provider.tf)
```
provider "aws" {
  access_key = "<AWS_ACCESS_KEY>"
  secret_key = "<AWS_SECRET_KEY>"
  region = "ap-northeast-2"
}
```
region은 리소스를 정의할 AWS리전을 의미합니다. 여기서 사용한 `ap-northeast-2`은 서울 리전을 의미합니다.

### 테라폼 프로젝트 초기화
루트 디렉터리에서 `terraform init` 명령어를 실행합니다.

## 첫 번째 이터레이션 : EC2용 SSH 키 페어 정의
지금까지 테라폼을 사용하기위한 준비 작업이었다면, 이제 AWS 리소스를 정의할 차례입니다. 첫번째 리소스는 `aws_key_pair`입니다.  
이 리소스는 AWS EC2를 생성할 때 사용되는 리소스입니다. EC2 인스턴스를 생성하더라도 `key_pair`가 없다면 생성한 인스턴스에 접근할 수 없습니다.
따라서 인스턴스를 생성하기 전에 키 페이를 먼저 생성해야합니다.

### 첫 번째 스탭 : HCL언어로 필요한 리소스를 정의
`web_infra.tf`에 다음과 같은 내용을 추가해줍니다.
```
resource "aws_key_pair" "web_admin" {
  key_name = "web_admin"
  public_key = "<PUBLIC_KEY>"
}
```